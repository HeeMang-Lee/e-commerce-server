# 부하 테스트 계획서

## 1. 개요

### 1.1 목적

이커머스 서비스의 핵심 API에 대해 부하 테스트를 수행하여:
- 시스템의 **처리량 한계(TPS)** 파악
- **병목 지점** 탐색 및 개선점 도출
- 동시성 제어가 고부하 상황에서도 정상 동작하는지 검증
- 적정 **인프라 스펙** 산정을 위한 기초 데이터 확보

### 1.2 테스트 도구

| 도구 | 용도 |
|------|------|
| **K6** | 부하 테스트 스크립트 작성 및 실행 |
| **Prometheus** | 메트릭 수집 (CPU, 메모리, JVM, Redis, Kafka) |
| **Grafana** | 메트릭 시각화 및 대시보드 |
| **Docker** | 테스트 환경 구성 |

### 1.3 테스트 환경

```
┌─────────────────────────────────────────────────────────────┐
│                      Test Environment                        │
├─────────────────────────────────────────────────────────────┤
│  K6 (Load Generator)                                         │
│       │                                                      │
│       ▼                                                      │
│  Spring Boot App (target: localhost:8080)                   │
│       │                                                      │
│       ├── MySQL 8.0 (localhost:3306)                        │
│       ├── Redis 7.2 (localhost:6379)                        │
│       └── Kafka 7.4 (localhost:9092)                        │
│                                                              │
│  Monitoring:                                                 │
│       ├── Prometheus (localhost:9090)                       │
│       ├── Grafana (localhost:3000)                          │
│       ├── Redis Exporter (localhost:9121)                   │
│       └── Kafka Exporter (localhost:9308)                   │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 테스트 대상 API

### 2.1 선정 기준

1. **동시성 제어가 필요한 기능** - 분산락, 수량 제한
2. **트래픽 폭증 가능성** - 선착순 이벤트, 인기 상품
3. **비즈니스 핵심 기능** - 주문, 결제

### 2.2 테스트 대상

| 우선순위 | API | 메서드 | 엔드포인트 | 선정 이유 |
|---------|-----|--------|-----------|----------|
| 1 | 선착순 쿠폰 발급 | POST | `/api/coupons/issue` | 동시성 제어 핵심, Redis+Kafka 조합 |
| 2 | 상품 주문 생성 | POST | `/api/orders` | 재고 차감 + 분산락 |
| 3 | 주문 결제 | POST | `/api/orders/{id}/payment` | 포인트+쿠폰+재고 통합 처리 |
| 4 | 인기 상품 조회 | GET | `/api/products/popular` | 캐시 효과 검증 |
| 5 | 포인트 충전 | POST | `/api/points/charge` | 분산락 경합 |

---

## 3. 테스트 시나리오

### 3.1 시나리오 1: 선착순 쿠폰 발급 (Peak Test)

**목적**: 선착순 쿠폰 발급 시 동시성 제어 및 처리량 검증

**시나리오 설정**:
```
- 쿠폰 수량: 500개
- 동시 사용자: 10,000명
- 목표: 정확히 500명만 발급 성공, 나머지 실패
```

**부하 패턴**:
```
VUs (Virtual Users)
  │
10K├─────────────────────────────
  │        ╱              ╲
5K ├───────╱                ╲──────
  │      ╱                    ╲
  │     ╱                      ╲
0 ├────╱────────────────────────╲────
  0   10s   30s          90s   120s
       ↑     ↑            ↑
    ramp-up peak      ramp-down
```

**검증 항목**:
- [ ] 발급 성공 수 = 쿠폰 수량 (정확히 500개)
- [ ] 중복 발급 0건
- [ ] P99 응답시간 < 3초
- [ ] 에러율 (SOLD_OUT 제외) < 1%

---

### 3.2 시나리오 2: 상품 주문 생성 (Load Test)

**목적**: 재고 차감 시 동시성 제어 및 TPS 한계 측정

**시나리오 설정**:
```
- 상품 재고: 1,000개
- 동시 사용자: 2,000명
- 주문 수량: 각 1개씩
- 목표: 1,000명 성공, 1,000명 재고 부족 실패
```

**부하 패턴**:
```
VUs
  │
2K ├───────────────────────────
  │      ╱                   ╲
1K├─────╱                     ╲────
  │    ╱                       ╲
0 ├───╱─────────────────────────╲──
  0  30s                    180s 210s
```

**검증 항목**:
- [ ] 최종 재고 = 0 (음수 안 됨)
- [ ] 성공 주문 수 = 초기 재고
- [ ] P95 응답시간 < 2초
- [ ] 데드락 발생 0건

---

### 3.3 시나리오 3: 주문 결제 (Stress Test)

**목적**: 결제 프로세스 전체 흐름의 안정성 검증

**시나리오 설정**:
```
- 사전 조건: 주문 1,000건 생성 완료
- 동시 결제 요청: 점진적 증가 (100 → 500 → 1,000)
- 포인트 사용 + 쿠폰 적용 혼합
```

**부하 패턴**:
```
VUs
  │                        1000
1K├────────────────────────────
  │                 ╱
500├────────────────╱
  │        ╱       │
100├────────╱────────│──────────
  │   ╱    │       │
0 ├──╱─────│───────│───────────
  0  60s  120s   180s      300s
```

**검증 항목**:
- [ ] 포인트 정합성 유지
- [ ] 쿠폰 중복 사용 0건
- [ ] 보상 트랜잭션 정상 동작
- [ ] TPS 한계점 측정

---

### 3.4 시나리오 4: 인기 상품 조회 (Load Test)

**목적**: 캐시 효과 및 Cache Stampede 방지 검증

**시나리오 설정**:
```
Case A: 캐시 활성화 (Redis + Caffeine)
Case B: 캐시 비활성화 (DB 직접 조회)
동시 사용자: 1,000명
지속 시간: 3분
```

**검증 항목**:
- [ ] Case A vs B 응답시간 비교
- [ ] Cache Hit Rate > 95%
- [ ] DB 쿼리 수 비교
- [ ] P99 응답시간 비교

---

### 3.5 시나리오 5: 포인트 동시 충전 (Stress Test)

**목적**: 같은 사용자에 대한 동시 요청 시 정합성 검증

**시나리오 설정**:
```
- 사용자 100명
- 각 사용자당 동시 충전 요청 10건 (총 1,000건)
- 충전 금액: 1,000원씩
- 기대 결과: 각 사용자 잔액 = 초기 + 10,000원
```

**검증 항목**:
- [ ] 최종 포인트 잔액 정합성
- [ ] 포인트 이력 누락 0건
- [ ] 분산락 경합으로 인한 실패 비율

---

## 4. 성능 지표 (SLI/SLO)

### 4.1 목표 지표

| 지표 | 목표값 | 측정 방법 |
|------|--------|----------|
| **TPS** | > 500 req/s | K6 metrics |
| **P50 응답시간** | < 100ms | K6 http_req_duration |
| **P95 응답시간** | < 500ms | K6 http_req_duration |
| **P99 응답시간** | < 2,000ms | K6 http_req_duration |
| **에러율** | < 1% (비즈니스 오류 제외) | K6 http_req_failed |
| **CPU 사용률** | 평상시 < 50% | Prometheus |
| **메모리 사용률** | < 80% | Prometheus |
| **Redis 명령 처리량** | 모니터링 | Redis Exporter |
| **Kafka Consumer Lag** | < 1,000 | Kafka Exporter |

### 4.2 임계치 알람 기준

| 지표 | Warning | Critical |
|------|---------|----------|
| CPU | > 70% | > 90% |
| Memory | > 70% | > 85% |
| P99 Latency | > 3s | > 5s |
| Error Rate | > 1% | > 5% |
| Kafka Lag | > 5,000 | > 10,000 |

---

## 5. 테스트 실행 계획

### 5.1 사전 준비

1. **테스트 데이터 셋업**
   - 사용자 10,000명 생성
   - 상품 10종 (재고 각 1,000개)
   - 쿠폰 5종 (수량 각 500개)
   - 각 사용자 포인트 100,000원

2. **모니터링 환경 구성**
   - Prometheus + Grafana 실행
   - Redis Exporter, Kafka Exporter 연동
   - JVM 메트릭 노출 (Actuator)

3. **K6 스크립트 검증**
   - 소규모 (VU=10) 테스트로 스크립트 동작 확인

### 5.2 실행 순서

| 단계 | 시나리오 | 예상 소요 |
|------|----------|----------|
| 1 | 인기 상품 조회 (워밍업) | 5분 |
| 2 | 포인트 충전 | 10분 |
| 3 | 상품 주문 생성 | 10분 |
| 4 | 주문 결제 | 15분 |
| 5 | **선착순 쿠폰 발급** | 10분 |

### 5.3 결과 수집

- K6 Summary 리포트
- Grafana 대시보드 스크린샷
- 병목 구간 분석 로그
- 개선 전/후 비교 데이터

---

## 6. 병목 예상 지점

### 6.1 예상 병목

| 구간 | 예상 원인 | 확인 방법 |
|------|----------|----------|
| 분산락 대기 | Redisson Lock 경합 | Lock 획득 대기시간 로그 |
| DB 커넥션 | HikariCP 풀 소진 | Hikari 메트릭 |
| Redis 처리량 | 단일 스레드 한계 | Redis INFO stats |
| Kafka Consumer | 처리 속도 < 발행 속도 | Consumer Lag |
| GC Pause | 힙 메모리 부족 | GC 로그 |

### 6.2 모니터링 대시보드 구성

```
┌─────────────────────────────────────────────────────────────┐
│  K6 Performance Dashboard                                    │
├─────────────────────────────────────────────────────────────┤
│  [ TPS ]  [ Response Time (P50/P95/P99) ]  [ Error Rate ]   │
├─────────────────────────────────────────────────────────────┤
│  JVM Metrics                                                 │
│  [ Heap Usage ]  [ GC Pause ]  [ Thread Count ]             │
├─────────────────────────────────────────────────────────────┤
│  Infrastructure                                              │
│  [ CPU ]  [ Memory ]  [ Network I/O ]                       │
├─────────────────────────────────────────────────────────────┤
│  Redis Metrics                                               │
│  [ Commands/sec ]  [ Memory ]  [ Connected Clients ]        │
├─────────────────────────────────────────────────────────────┤
│  Kafka Metrics                                               │
│  [ Messages/sec ]  [ Consumer Lag ]  [ Partition Count ]    │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. 참고 자료

- [K6 Documentation](https://k6.io/docs/)
- [Prometheus + Grafana 설정 가이드](https://prometheus.io/docs/)
- [Redis Exporter](https://github.com/oliver006/redis_exporter)
- [Kafka Exporter](https://github.com/danielqsj/kafka_exporter)
- 프로젝트 문서: `07_CONCURRENCY_PROBLEM_ANALYSIS.md`, `08_DISTRIBUTED_LOCK_AND_CACHING_REPORT.md`
